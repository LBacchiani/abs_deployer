module FredhopperCloudServices;

/**************************************************************
Mandatory imports and exports
**************************************************************/
export *;
import * from ABS.DC;
import * from ABS.SmartDeploy;



/**************************************************************
// Definition of classes with their cost annotations
**************************************************************/

//abstraction for a customer
type Customer = String;

//abstraction for an identifier
type Id = Int;
def Id init() = 1;
def Id incr(Id id) = id + 1;

//abstraction for a request
type Request = Int;
def Int cost(Request request) = request;

//abstraction for a response
type Response = Bool;
def Response success() = True;
def Bool isSuccess(Response response) = response; 

//There exists an enumerated number of service types... 
data ServiceType = FAS | SUGGEST | DM;

// A Service configuration defines 
// * serviceType -- the type of service offered
// * instances -- the amount of resources each instance consumes
data Config = Config(ServiceType serviceType, List<Int> instances); 

// Process state
data State = RUNNING | STOP;

//  Models an infrastructure service that allows one to acquire and release cpu resources
interface InfrastructureService { }

//[Deploy: scenario[Name("amazon_scenario1"), Cost("Cores", 1)] ]
[Deploy: scenario[Name("amazon_scenario"), Cost("amazon_res",1)]]
class InfrastructureServiceImpl implements InfrastructureService {
	// ...
}



// An endpoint is where service user connects to a service
interface EndPoint { }

interface LoadBalancerEndPoint extends EndPoint { }

// A service instance offers a single end point 
// A service has a service type, defining the kind of service offered
// A service belong to a customer
// A service exposes logging information
interface Service extends EndPoint { }

// load balance over n services in round robin style
class LoadBalancerEndPointImpl(List<Service> services) implements LoadBalancerEndPoint {
}

// An interface offered to InfrastructureService to allocate resources
interface ResourceService extends Service { }

class ServiceImpl(Id serviceId, ServiceType st, Customer c, Int cost) implements ResourceService {
	// ...
}

// A deployment service helps to deploy ALL types of service instance onto required cpu resources.
interface DeploymentService { } 


[Deploy: scenario[MaxUse(2),Cost("Cores", 1), Cost("Memory", 80), Param("rp", Req), Param("p",Req)]]
class DeploymentServiceImpl(InfrastructureService rp, PlatformService p) implements DeploymentService {
	// ...
}

// A load balancer service distributes request over service instances
// A load balancer can enable or disable a service
// TODO annotations on interfaces might help to restrict or specifiy 
// requirements such that they should be observed by any object impl.
interface LoadBalancerService { }

//enum to specify whether to increase/decrease load balance resource
data LBOp = INCR | DECR;

[Deploy: scenario[Cost("Cores", 4), Cost("Memory", 8)] ]
//[Deploy: scenario[Name("on_premises"), Cost("on_premises_res",1)]]
class LoadBalancerServiceImpl implements LoadBalancerService {
	// ...
}

//Platform service can create and remove a service
interface PlatformService { }

//Platform service used by monitor to scale up/down a service
interface MonitorPlatformService extends PlatformService { }


[Deploy: scenario[Cost("Cores", 4), Cost("Memory", 12), Param("ls", Req)]]
//[Deploy: scenario[Name("on_premises"), Cost("on_premises_res",1), Param("dsList", List(2)), Param("ls", Req)]]
class PlatformServiceImpl(LoadBalancerService ls) 
implements MonitorPlatformService {
	// ...
}

interface User { }

data Rule = Rule(Int interval, Monitor monitor); 

interface MonitoringService { }

class MonitoringServiceImpl implements MonitoringService {
	// ..
}

interface Monitor { }

interface Action { }

//A monitor that checks the latency of a service endpoint
class LatencyMonitor(Int upper, MonitorPlatformService ps) implements Monitor {
	// ...
}

class ScaleResourceAction(List<Pair<Id, Int>> scalings, MonitorPlatformService ps) implements Action {
	// ...
}


data Scale = UP | DOWN;

//scale up/down the number of instances according to the scaling setting
//scaling setting is a list of pairs of endpoint id to the number of instances to add/remove  
class ScaleInstanceAction(List<Triple<Int, Scale, List<Int>>> scalings, MonitorPlatformService ps) implements Action {
	// ...
}

/**
* Models a cloud service provider such as Fredhopper
**/
interface ServiceProvider { }

[Deploy: scenario[Param("ps", Req), Param("ls", Req)] ]
class ServiceProviderImpl(PlatformService ps, LoadBalancerService ls) implements ServiceProvider {
 // ...
}



/* Example of a service to deploy: query service of the Fredhopper Access Server 
*/
interface Item {
}

interface IQueryService extends Service { }

// Stub implementation of the query service, for use with cost annotations
[Deploy: scenario[MaxUse(1), Cost("Cores", 1), Cost("Memory", 400), Param("c", Default("\\\"Customer X\\\"")), Param("ds", Req)] ]
class QueryServiceImpl(DeploymentService ds, Customer c) implements IQueryService {
	// ....
}


/**************************************************************
// MAIN
**************************************************************/

{

	CloudProvider cloudProvider = new CloudProvider("CloudProvider");
	// Definition of the deployment components
	cloudProvider.addInstanceDescription(Pair("c3.xlarge", InsertAssoc(Pair(CostPerInterval,210), InsertAssoc( Pair(Memory,750), InsertAssoc(Pair(Cores,4), EmptyMap)))));
	cloudProvider.addInstanceDescription(Pair("c3.large", InsertAssoc(Pair(CostPerInterval,105), InsertAssoc( Pair(Memory,375), InsertAssoc(Pair(Cores,2), EmptyMap)))));

	DeploymentComponent amazon_eu = new DeploymentComponent("amazon_eu", EmptyMap);
	DeploymentComponent amazon_us = new DeploymentComponent("amazon_us", EmptyMap);


/* JSON ANNOTATION
{
	"id": "MainSmartDeployer",
	"specification": "QueryServiceImpl = 2 and LoadBalancerServiceImpl > 0 and PlatformServiceImpl > 0 and ServiceProviderImpl > 0 and forall ?x in DC: ( ?x.QueryServiceImpl < 2 and ( ?x.QueryServiceImpl = 1 impl ?x.DeploymentServiceImpl > 0) and (?x.ServiceProviderImpl > 0 impl ?x.PlatformServiceImpl > 0) and ( ?x.ServiceProviderImpl > 0 impl  (sum ?y in obj:  ?x.?y) = ?x.ServiceProviderImpl + ?x.PlatformServiceImpl) and (?x.LoadBalancerServiceImpl > 0 impl (sum ?y in obj: ?x.?y) = ?x.LoadBalancerServiceImpl) and (?x.InfrastructureServiceImpl[amazon_scenario] > 0 impl  (sum ?y in obj: ?x.?y) = ?x.InfrastructureServiceImpl[amazon_scenario]))",
	"DC": [{
		"name": "amazon_eu",
		"amazon_res": 10
	}],
	"obj": [],
	"cloud_provider_DC_availability" : { "c3.large" : 3}
}
**/
	

	[ SmartDeploy : "{\"id\":\"MainSmartDeployer\",\"specification\":\"QueryServiceImpl = 2 and LoadBalancerServiceImpl > 0 and PlatformServiceImpl > 0 and ServiceProviderImpl > 0 and forall ?x in DC: ( ?x.QueryServiceImpl < 2 and ( ?x.QueryServiceImpl = 1 impl ?x.DeploymentServiceImpl > 0) and (?x.ServiceProviderImpl > 0 impl ?x.PlatformServiceImpl > 0) and ( ?x.ServiceProviderImpl > 0 impl  (sum ?y in obj:  ?x.?y) = ?x.ServiceProviderImpl + ?x.PlatformServiceImpl) and (?x.LoadBalancerServiceImpl > 0 impl (sum ?y in obj: ?x.?y) = ?x.LoadBalancerServiceImpl) and (?x.InfrastructureServiceImpl[amazon_scenario] > 0 impl  (sum ?y in obj: ?x.?y) = ?x.InfrastructureServiceImpl[amazon_scenario]))\",\"DC\":[{\"name\":\"amazon_eu\",\"amazon_res\":10}],\"obj\":[],\"cloud_provider_DC_availability\":{\"c3.large\":3}}" ]
	SmartDeployInterface c1 = new MainSmartDeployer(cloudProvider,amazon_eu);
	c1.deploy();

	List<InfrastructureService> infrastructureServices = c1.getInfrastructureService();
	List<PlatformService> platformServices = c1.getPlatformService();
	List<LoadBalancerService> loadBalancerServices = c1.getLoadBalancerService();
	List<ServiceProvider> serviceProviders  = c1.getServiceProvider();


/** JSON ANNOTATION
{
  "id": "AddQueryDeployer",
  "specification": "QueryServiceImpl = 3 and forall ?x in DC: ( ?x.QueryServiceImpl < 2 and ( ?x.QueryServiceImpl = 1 impl ?x.DeploymentServiceImpl > 0) and (?x.ServiceProviderImpl > 0 impl ?x.PlatformServiceImpl > 0) and ( ?x.ServiceProviderImpl > 0 impl  (sum ?y in obj:  ?x.?y) = ?x.ServiceProviderImpl + ?x.PlatformServiceImpl) and (?x.LoadBalancerServiceImpl > 0 impl (sum ?y in obj: ?x.?y) = ?x.LoadBalancerServiceImpl) and (?x.InfrastructureServiceImpl[amazon_scenario] > 0 impl  (sum ?y in obj: ?x.?y) = ?x.InfrastructureServiceImpl[amazon_scenario]))",
  "DC": [
    {
      "name": "amazon_us",
      "amazon_res": 10
    }
  ],
  "obj": [
    {
      "name": "infrastructureObj",
      "provides": [
        {
          "ports": [
            "InfrastructureService"
          ],
          "num": 1
        }
      ],
      "interface": "InfrastructureService"
    },
    {
      "name": "platformObj",
      "provides": [
        {
          "ports": [
            "MonitorPlatformService",
            "PlatformService"
          ],
          "num": -1
        }
      ],
      "interface": "PlatformService"
    },
    {
      "name": "loadBalancerObj",
      "provides": [
        {
          "ports": [
            "LoadBalancerService"
          ],
          "num": -1
        }
      ],
      "interface": "LoadBalancerService"
    },
    {
      "name": "serviceProviderObj",
      "provides": [
        {
          "ports": [
            "ServiceProvider"
          ],
          "num": -1
        }
      ],
      "interface": "ServiceProvider"
    }
  ]
}
**/


	[ SmartDeploy : "{\"id\":\"AddQueryDeployer\",\"specification\":\"QueryServiceImpl = 3 and forall ?x in DC: ( ?x.QueryServiceImpl < 2 and ( ?x.QueryServiceImpl = 1 impl ?x.DeploymentServiceImpl > 0) and (?x.ServiceProviderImpl > 0 impl ?x.PlatformServiceImpl > 0) and ( ?x.ServiceProviderImpl > 0 impl  (sum ?y in obj:  ?x.?y) = ?x.ServiceProviderImpl + ?x.PlatformServiceImpl) and (?x.LoadBalancerServiceImpl > 0 impl (sum ?y in obj: ?x.?y) = ?x.LoadBalancerServiceImpl) and (?x.InfrastructureServiceImpl[amazon_scenario] > 0 impl  (sum ?y in obj: ?x.?y) = ?x.InfrastructureServiceImpl[amazon_scenario]))\",\"DC\":[{\"name\":\"amazon_us\",\"amazon_res\":10}],\"obj\":[{\"name\":\"infrastructureObj\",\"provides\":[{\"ports\":[\"InfrastructureService\"],\"num\":1}],\"interface\":\"InfrastructureService\"},{\"name\":\"platformObj\",\"provides\":[{\"ports\":[\"MonitorPlatformService\",\"PlatformService\"],\"num\":-1}],\"interface\":\"PlatformService\"},{\"name\":\"loadBalancerObj\",\"provides\":[{\"ports\":[\"LoadBalancerService\"],\"num\":-1}],\"interface\":\"LoadBalancerService\"},{\"name\":\"serviceProviderObj\",\"provides\":[{\"ports\":[\"ServiceProvider\"],\"num\":-1}],\"interface\":\"ServiceProvider\"}]}" ]
	SmartDeployInterface c2 = new AddQueryDeployer(cloudProvider,amazon_us,head(infrastructureServices),head(platformServices),head(loadBalancerServices),head(serviceProviders));
	c2.deploy();


}

	
